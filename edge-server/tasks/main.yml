- name: Set globally available environment variables and ansible facts
  tags:
    - always
  ansible.builtin.include_tasks:
    file: facts.yml
    apply:
      tags:
        - always

- name: Create ~/opt directory if it does not exist
  tags:
    - always
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/opt/"
    state: directory
    mode: '0755'

- name: Install apt packages
  tags:
    - apt
    - sep_deploy
  ansible.builtin.include_tasks:
    file: apt.yml
    apply:
      tags:
        - apt
        - sep_deploy

- name: Update installed apt packages
  when: deb_arch == "amd64"  # FIXME Jetson can't `apt upgrade` (break Docker filesystem as result)
  tags:
    - apt
    - sep_deploy
  ansible.builtin.include_tasks:
    file: apt-upgrade.yml
    apply:
      tags:
        - apt
        - sep_deploy

- name: Install Nvidia GPU drivers and tools
  tags:
    - apt
  when:
    - tapway_gpu_var == "gpu"
    - not nvidia_driver
  ansible.builtin.include_tasks:
    file: gpu.yml
    apply:
      tags:
        - apt

- name: Install Jetson drivers and tools  # TODO install same version as netdata docker image
  tags:
    - jetson
  when:
    - deb_arch == "arm64"
    - not jtop
  ansible.builtin.include_tasks:
    file: jetson.yml
    apply:
      tags:
        - jetson

- name: Install and configure shell history search
  when: deb_arch == "amd64"
  tags:
    - dev
  ansible.builtin.include_tasks:
    file: hstr.yml
    apply:
      tags:
        - dev

- name: Customize bash configuration
  tags:
    - dev
  ansible.builtin.include_tasks:
    file: bashrc.yml
    apply:
      tags:
        - dev

- name: Setup Docker
  tags:
    - docker
    - sep_deploy
  ansible.builtin.include_tasks:
    file: docker.yml
    apply:
      tags:
        - docker
        - sep_deploy

- name: Setup Docker Compose
  when:
    - docker_compose_version_var != docker_compose_version
  tags:
    - docker
    - sep_deploy
  ansible.builtin.include_tasks:
    file: docker-compose.yml
    apply:
      tags:
        - docker
        - sep_deploy

- name: Setup AWS Greengrass
  tags:
    - gg
  ansible.builtin.include_tasks:
    file: gg.yml
    apply:
      tags:
        - gg

- name: Install Haikang camera MVS
  tags:
    - mvs
  ansible.builtin.include_tasks:
    file: mvs.yml
    apply:
      tags:
        - mvs

- name: Install Manager service compose stack
  tags:
    - manager
  ansible.builtin.include_tasks:
    file: manager.yml
    apply:
      tags:
        - manager

- name: Setup Portainer
  tags:
    - portainer
    - dev
    - sep_deploy
  ansible.builtin.include_tasks:
    file: portainer.yml
    apply:
      tags:
        - portainer
        - dev
        - sep_deploy

- name: Setup Monitoring
  tags:
    - monitoring
    - sep_deploy
  ansible.builtin.include_tasks:
    file: monitoring.yml
    apply:
      tags:
        - monitoring
        - sep_deploy

- name: Cronjob to Delete images
  tags:
    - delete_images
  ansible.builtin.include_tasks:
    file: delete-images.yml
    apply:
      tags:
        - delete_images

- name: Install and Setup NFS
  when: hosts_info is defined and hosts_info != ""
  tags:
    - nfs
  ansible.builtin.include_tasks:
    file: nfs.yml
    apply:
      tags:
        - nfs

- name: Setup for Separate Deployment
  when: hosts_info is defined and ansible_default_ipv4.address == inference_ip
  tags:
    - deploy
  ansible.builtin.include_tasks:
    file: sep_deployment.yml
    apply:
      tags:
        - deploy
